<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Mar 6, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Auto generated" />
    <meta name="Date-Revision-yyyymmdd" content="20130306" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ITK API and Reference Implementation - 
      ITK requirements and Reference Implementation Cross-reference</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<link rel="stylesheet" href="css/itk-mini-site.css"></link>
                      
        
<link rel="stylesheet" type="text/css" href="js/prettify.css"></link>
                      
        
<script src="js/prettify.js" type="text/javascript"></script>
                      
        
<script src="js/itk-api-site.js" type="text/javascript"></script>
          
            </head>
        <body class="topBarEnabled">
          
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
                                  <div class="container"><div class="nav-collapse">
            
                
                                                                                <a class="brand" href="index.html"  title="IRK">

                                
                                                                                                                    <img src="images/itk-small.gif" alt="IRK" />
                
                </a>
                    
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Scenarios <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="scenarios-overview.html"  title="Scenarios Overview">Scenarios Overview</a>
</li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Synchronous"  title="Synchronous">Synchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="sync-query-sender.html"  title="Spine Mini-Services (client)">Spine Mini-Services (client)</a>
</li>
                                  <li>      <a href="sync-query-receiver.html"  title="Spine Mini-Services (provider)">Spine Mini-Services (provider)</a>
</li>
                                  <li>      <a href="simple-sync-fireandforget.html"  title="ADT Admit Patient (P/H)">ADT Admit Patient (P/H)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Simple Asynchronous"  title="Simple Asynchronous">Simple Asynchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="simple-async-adt-query.html"  title="ADT Query patient (XML)">ADT Query patient (XML)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Routed Message"  title="Routed Message">Routed Message</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="routed-cda-document-repo.html"  title="Routed CDA (document repository)">Routed CDA (document repository)</a>
</li>
                                  <li>      <a href="routed-cda-with-business-ack.html"  title="Routed CDA (with business Ack)">Routed CDA (with business Ack)</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Reports <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="index.html"  title="About">About</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="modules.html"  title="Project Modules">Project Modules</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="../itk-api/index.html"  title="ITK API">ITK API</a>
</li>
                  
                      <li>      <a href="../itk-ri/index.html"  title="ITK Java Reference Implementation">ITK Java Reference Implementation</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="ITK Samples project">ITK Samples project</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="requirements-cross-ref.html"  title="ITK Requirement traceability">ITK Requirement traceability</a>
</li>
                  
                      <li>      <a href="../itk-api/apidocs/index.html"  title="Javadocs (API only)">Javadocs (API only)</a>
</li>
                  
                      <li>      <a href="apidocs/index.html"  title="Javadocs (API + RI + Samples)">Javadocs (API + RI + Samples)</a>
</li>
                  
                      <li>      <a href="xref/index.html"  title="Java source cross-reference">Java source cross-reference</a>
</li>
                  
                      <li>      <a href="../itk-samples/downloads.html"  title="Downloads">Downloads</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="Install Guide">Install Guide</a>
</li>
                  
                      <li>      <a href="docs/ITK Basic Workshop v0.1 - Webex.pdf"  target="_blank" title="ITK Basic Workshop - Webex Slides">ITK Basic Workshop - Webex Slides</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Disclaimer <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="disclaimer.html"  title="Disclaimer">Disclaimer</a>
</li>
                          </ul>
      </li>
                  </ul>
          
          
                                                              
                               <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
                      <li>      <a href="http://services.developer.nhs.uk/itk-samples/"  title="ITK RI (Running samples)">ITK RI (Running samples)</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop"  title="CFH ITK home page">CFH ITK home page</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop/fund"  title="ISCF">ISCF</a>
</li>
      <li>      <a href="http://www.uktcregistration.nss.cfh.nhs.uk/trud3/user/guest/group/0/pack/21"  title="ITK @ TRUD">ITK @ TRUD</a>
</li>
      <li>      <a href="http://www.networks.nhs.uk/nhs-networks/interoperability-toolkit-itk"  title="ITK @ NHS Networks">ITK @ NHS Networks</a>
</li>
      <li>      <a href="http://www.linkedin.com/groups/NHS-Interoperability-Toolkit-3831338"  title="ITK @ LinkedIn">ITK @ LinkedIn</a>
</li>
                  </ul>
              </li>
            </ul>
          
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>ITK API and Reference Implementation mini-site</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
            
                
                    
      
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            
   
      <div class="section"><h2>Spine Mini-Services Provider - Get Patient Details by NHSNumber<a name="Spine_Mini-Services_Provider_-_Get_Patient_Details_by_NHSNumber"></a></h2>
          
        <ul class="nav nav-tabs tab-control">
          <li class="active"><a href="#overview">Overview</a></li>
          <li><a href="#sender">SMS Client</a></li>
          <li><a href="#receiver">SMS Provider</a></li>
          <li><a href="#request">Request</a></li>
          <li><a href="#response">Response</a></li>
        </ul>       
         <div class="row-fluid" style="min-height: 480px;">
    <div class="span5">
       
       <div class="clickablemapview">
          <p class="tab-title">Black box view</p>
          <img src="images/smsp - black-box view.jpg" usemap="#bbviewmap" alt="" />
          <map name="bbviewmap">
              <area shape="rect" coords="11,8,102,57" title="SMS Client" href="#sender"></area>
              <area shape="rect" coords="348,8,438,57" title="SMS Provider" href="#receiver"></area>
              <area shape="rect" coords="125,80,325,110" title="Get Patient Details By NHSNumber Request" href="#request"></area>
              <area shape="rect" coords="125,160,325,180" title="Get Patient Details By NHSNumber Response" href="#response"></area>
           </map>
       </div>    
    </div>
    <div class="span7">
        <div class="tab-content">
  <div class="tab-pane active" id="overview">
        <p class="tab-title">Overview</p>
        <p>In this scenario a client application is indirectly querying Spine PDS to obtain demographic information held for the provided NHSNumber. From a business perspective this is typically used to check (and/or potentially update) the locally held demographic details about the patient from the national Patient Demographic Service.</p>
        <p>The following describes the logic required to invoke the ITK <tt>urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0</tt> service.</p>
        <p>From a black-box perspective the invocation of a Spine Mini-Service Provider web service interface is fairly trivial. The service requestor simply sends the appropriate ITK request message and receives the response synchronously. Likewise any exceptions will be returned as synchronous SOAP Faults.</p>
  </div>
  <div class="tab-pane" id="sender">
        <p class="tab-title">Spine Mini-Services - Client</p>
        <p>As the SMS client already has the pertient patient's NHSNumber in their local data store the query to get the latest demographics via the SMS Provider is relatively straightforward. The SMS Client builds the Get Patient Details By NHSNumber Request query message providing the patient's NHSNumber and Date of Birth.</p>
  </div>
  <div class="tab-pane" id="receiver">
        <p class="tab-title">Spine Mini-Services - Provider</p>
        <p>The SMS Provider is a unique component in ITK - providing a bridge between the Spine PDS interfaces and Spine Mini Service Clients. In a real deployment, the SMSP would receieve the ITK Get Patient Details By NHSNumber Request, make one or more queries to Spine services the results of which are used construct the appropriate ITK Get Patient Details By NHSNumber Response.</p>
        <p>In the samples application the SMSP is emulated via a simple XSLT that creates a response from the request</p>
  </div>
  <div class="tab-pane" id="request">
      <p class="tab-title">Get Patient Details By NHSNumber Request
      <a href="samples/GetPatientDetailsByNHSNumberRequest.xml" target="_blank" type="text/xml">(Get example)</a></p>
      <div class="source"><pre class="prettyprint linenums">&lt;soap:Envelope xmlns:itk=&quot;urn:nhs-itk:ns:201005&quot; ...&gt;
  &lt;soap:Header&gt;
    ...
    &lt;wsa:To&gt;http://www.example.com/sync&lt;/wsa:To&gt;
    &lt;wsa:From&gt;&lt;wsa:Address&gt;http://127.0.0.1:4000/syncsoap&lt;/wsa:Address&gt;&lt;/wsa:From&gt;
  &lt;/soap:Header&gt;
  &lt;soap:Body&gt;
    &lt;itk:DistributionEnvelope&gt;
      &lt;itk:header service=&quot;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0&quot; ...&gt;  ... &lt;/itk:header&gt;
      &lt;itk:payloads count=&quot;1&quot;&gt;
        &lt;itk:payload id=&quot;uuid_D1F95107-42FD-4AB5-936F-A3D2A489DD61&quot;&gt;
          &lt;getPatientDetailsByNHSNumberRequest-v1-0 xmlns=&quot;urn:hl7-org:v3&quot; ...&gt;
                    ...
          &lt;/getPatientDetailsByNHSNumberRequest-v1-0&gt;
        &lt;/itk:payload&gt;
      &lt;/itk:payloads&gt;
    &lt;/itk:DistributionEnvelope&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre></div>
  </div>
  <div class="tab-pane" id="response">
      <p class="tab-title">Get Patient Details By NHSNumber Response
      <a href="samples/GetPatientDetailsByNHSNumberResponse.xml" target="_blank" type="text/xml">(Get example)</a></p>
<div class="source"><pre class="prettyprint linenums">&lt;soap:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;...&gt;
  &lt;soap:Header&gt;
    ...
    &lt;wsa:Action&gt;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0Response&lt;/wsa:Action&gt;
    ...
  &lt;/soap:Header&gt;
  &lt;soap:Body&gt;
    &lt;itk:DistributionEnvelope&gt;
      &lt;itk:header service=&quot;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0Response&quot; ...&gt; ... &lt;/itk:header&gt;
      &lt;itk:payloads count=&quot;1&quot;&gt;
        &lt;itk:payload ...&gt;
          &lt;getPatientDetailsResponse-v1-0 xmlns=&quot;urn:hl7-org:v3&quot; ...&gt;
                  ...
          &lt;/getPatientDetailsResponse-v1-0&gt;
        &lt;/itk:payload&gt;
      &lt;/itk:payloads&gt;
    &lt;/itk:DistributionEnvelope&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre></div>      
  </div>
</div>
    </div>
</div>       
    </div>
    
    <div class="section"><h2>Walkthrough<a name="Walkthrough"></a></h2>
     <p>The following diagram shows how the SMSP emulation is achieved via the entry point  
          <tt>uk.nhs.interoperability.consumer.smsp.SMSProviderServlet</tt> from the <a href="../itk-samples/index.html">samples project</a>. This class uses the reference implementation to process the call from a Spine Mini Services client.</p>
         <img src="images/smsp - server.jpg" usemap="#serverseqmap" width="1300" alt="" />
         <map name="serverseqmap">
            <area shape="rect" coords="450,145,500,200" title="Step 1" href="#step-1"></area>
            <area shape="rect" coords="790,220,830,265" title="Step 2" href="#step-2"></area>
            <area shape="rect" coords="955,390,1100,440" title="Step 3" href="#step-3"></area>
            <area shape="rect" coords="450,540,500,600" title="Step 4" href="#step-4"></area>
         </map>
         <div id="step-1"></div>
         <div class="row-fluid horizontal-spacer">
             <div class="span5">
                 <p class="step-heading">Step <span class="label label-important label-large">1</span></p>
                 <p>The ITK Reference implementation uses Servlets to manage the HTTP protocol layers. The tradional Java interception point for interacting with the HTTP request is via the <tt>doPost()</tt> method to manage the POSTed HTTP message (ITK currently only supports HTTP POST as per SOAP).</p>
                 <p>The specific Servlet for this scenario is the <tt>uk.nhs.interoperability.consumer.smsp.SMSProviderServlet</tt>  however the <tt>doPost()</tt> method implementation is actually found within the reference implementation in the <a href="xref/uk/nhs/interoperability/consumer/AbstractSimpleMessageServlet.html#84">AbstractSimpleMessageServlet</a>.</p>
                 <p>Aside from reading the request message and error handling the majority of the processing logic is conatined within the <tt>processMessage()</tt> method shown to the right.</p>
                 <p>The <tt>processMessage()</tt> method uses XPath to extract the Distribution Envelope from the request message (line 6). Further XPaths are then applied to extract the <a href="">ITKMessageProperties</a> from the Distribution Envelope (line 8). Once these properties have been extracted the Distrubtion Envelope can be discarded: we only need to pass the (sceanrio specific) business payload to the application layer (extracted on lines 13-15).</p>
                 <p>Prior to invoking the application we perform transport/distribution layer validation (line 11). The full validation methods can be <a href="xref/uk/nhs/interoperability/consumer/ITKServlet.html#132">viewed in the source code</a> however we have extracted the ITK Profile Id check for a more in-depth view in <a href="#listing-2a">listing 2a</a> and <a href="#listing-2b">2b</a> below.</p>
                 <p>As per the API contract we need to pass an <a href="apidocs/uk/nhs/interoperability/payload/ITKMessage.html">ITKMessage</a> to the application layer - the specific instance is constructed (line 18) and the <a href="apidocs/uk/nhs/interoperability/consumer/ITKMessageConsumer.html#onSyncMessageuk.nhs.interoperability.payload.ITKMessage">onSyncMessage(ITKMessage request)</a> API call appropriate to the synchronous pattern is invoked.</p>             
             </div>
             <div class="span7">
             <div id="listing-1"></div>
           <div class="source"><pre class="prettyprint linenums">private ITKMessage processMessage(String requestString) throws ITKMessagingException { 
  ...
  Document doc = DomUtils.parse(requestString);
  ...
  //Extract the distribution envelope XML doc
  Document de = ITKMessagePropertiesImpl.extractDistributionEnvelopeFromSoap(doc);
  //Extract message properties from the Distribtion envelope XML
  itkMsgProps = (ITKMessagePropertiesImpl) ITKMessagePropertiesImpl.build(de);
  
  // Validate the message properties
  this.validateDistributionEnvelope(itkMsgProps);
  ...
  //Obtain the actual business payload
  Document busPayload = DomUtils.createDocumentFromNode((Node)XPaths.SOAP_WRAPPED_ITK_FIRST_PAYLOAD_XPATH.evaluate(...));
  String busPayloadXML = DomUtils.serialiseToXML(busPayload);
 
  //Construct the appropriate object for handing over to the application  
  ITKMessage request = new SimpleMessage(itkMsgProps, busPayloadXML);

  //Call the application layer (an instance of ITKMessageConsumer)
  ITKMessage response = this.messageConsumer.onSyncMessage(request);

  //Audit receipt event
  ITKSimpleAudit.getInstance().auditEvent(AuditService.MESSAGE_RECEIPT_EVENT...);

  //Add any wrappers such as the distribution envelope as necessary
  return this.addITKWrappers(response);	 
} </pre></div>
           <p class="caption"><b>Listing 1</b> deserialising the request message and invoking the destination application</p>
           </div>
         </div>
         
         <div id="step-2"></div>
         <div class="row-fluid horizontal-spacer">
             <div class="span6">
                 <div id="listing-2a"></div>
                 <div class="source"><pre class="prettyprint linenums">private void loadProps(Properties props) {
  ...
  //Read in supported profiles from properties
  Properties props = ITKApplicationProperties.getPropertiesMatching(props, &quot;profileId.&quot;);
  for (Map.Entry&lt;Object, Object&gt; entry : props.entrySet()) {
    String profileId = entry.getKey().toString().substring(...);
    String supportLevelStr = entry.getValue().toString();
    if (supportLevelStr.equalsIgnoreCase(&quot;ACCEPTED&quot;)) {
      profiles.put(profileId, new Integer(ITKProfileManager.ACCEPTED));
    } else if (... ) { ... } //deal with other supported levels
  }
}</pre></div>
                 <p class="caption"><b>Listing 2a</b> loading in profile support configuration</p>
                 <div id="listing-2b"></div>
                 <div class="source"><pre class="prettyprint linenums">public int getProfileSupportLevel(String profileId) {
  /*
   * If we know the profileId return the value from config,
   * otherwise default to not supported
   */
  return profiles.containsKey(profileId)
    ? profiles.get(profileId).intValue()
    : ITKProfileManager.NOT_SUPPORTED;
}</pre></div>
                 <p class="caption"><b>Listing 2b</b> runtime profile Id check</p>
             </div>
             <div class="span6">
                 <p class="step-heading">Step <span class="label label-important label-large">2</span></p>
                 <p>In the reference implementation we have made two design decisions about how the profileId check is managed.</p>
                  <ol style="list-style-type: decimal">
                      <li>The support levels for a given profile is determined by simple configuration - no run-time analysis is performed on the profile manifest XML published in the ITK specifications (the analysis is effectively performed by a human actor).</li>
                      <li>The transport / distribution layers manage the profile Id check on behalf of the application layer. This is for ease and consistency of implementation as the check is controlled by configuration anyway.</li>
                  </ol>                  
                  <p>An example profile configuration is: <tt>profileId.urn:nhs-en:profile:getPatientDetailsByNHSNumberRequest-v1-0=ACCEPTED</tt>. The full set of profile configuration is contained within the <tt>profile.properties</tt> configuration file within the itk-samples.war.</p>
                  <p>Possible values for the profileId configuration are:</p>
                  <ul>
                      <li>ACCEPTED: The profile id is known to be supported by the associated application layer components</li>
                      <li>DEPRECATED: The profile id is supported by the associated application layer components - however it is expected that the support will be removed within the near future (e.g. next six months).</li>
                      <li>NOT_SUPPORTED: The profile id is not supported by the associated application layer components - an exception should be raised. Lsting 2b (line 8) shows that this is also the default value if the profileId is not configured.</li>
                  </ul>
                  <p>The rationale for having a <i>DEPRECATED</i> status against a profile is to allow specific behaviour to be associated with this state. This behaviour might include logging to a specific file to monitor live traffic or raising SNMP events to operational support. Strictly speaking there is no ITK requirement to support the <i>DEPRECATED</i> state - however supporting this in the reference implementation whilst maintaining alignment with the specification was fairly trivial.</p>
                  <p>The source code for the <a class="externalLink" href="file:///home/michael/workspace/itk-api-mini-site/target/itk/docs/xref/uk/nhs/interoperability/consumer/ITKProfileManagerImpl.html#34">ITKProfileManagerImpl</a> shows the full details of the implementation.</p>
             </div>
         </div>
         
         <div id="step-3"></div>
         <div class="row-fluid  horizontal-spacer">
             <div class="span12">
                 <p class="step-heading">Step <span class="label label-important label-large">3</span></p>
                 <p>In the samples application the Spine Mini-Service Provider is only a stubbed implementation - there are no calls to Spine PDS and it does not attempt to fufil the SMSP requirements. </p>
                 <p>The application layer components are bound to the transport layer via the <a href="xref/uk/nhs/interoperability/consumer/smsp/SMSProviderServlet.html#50">getMessageConsumer()</a> operation within the <tt>SMSProviderServlet</tt>. In this example this returns a <a href="xref/uk/nhs/interoperability/consumer/appemulator/SimpleApplicationEmulator.html#48">SimpleApplicationEmulator</a> which uses configuration (<tt>consumeremulator.properties</tt>) and XSLT to provide syntactically valid responses. In this scenario the <tt>getPatientDetailsByNHSNumber-v1-0</tt> request message is converted into a <tt>getPatientDetailsResponse-v1-0</tt> message which is subsequently returned to the transport / distribution layers.</p>
             </div>
         </div>
         
         <div id="step-4"></div>
         <div class="row-fluid horizontal-spacer">             
             
             <div class="span6">
                 <p class="step-heading">Step <span class="label label-important label-large">4</span></p>
                 <p>Once the response is receieved from the applicaiton layer - the transport / distribution layers only need to add the appropriate wrappers and serialise the response to the HTTP response.</p>
                 <p>Listing 4a - shows the logic to determine whether or not a Distribution Envelope is required (line 4) and, if it a DE is required, adding it (line 12). There is also additional logic to determine whether or not the business payload should be base64 encoded (line 6-11), however this is only required for <a href="simple-sync-fireandforget.html">pipe and hat HL7v2 messages</a>.</p>
                 <p>Listing 4b - shows the additional SOAP wrapper layers being added by the <a href="xref/uk/nhs/interoperability/consumer/AbstractSimpleMessageServlet.html#106">HTTP/WS transport specific implementation</a>.</p>
             </div>
             <div class="span6">    
                 <div id="listing-4"></div>             
                 <div class="source"><pre class="prettyprint linenums">protected ITKMessage addITKWrappers(ITKMessage itkMessage) throws ITKMessagingException {
  ...
  //Detemine whether to add Distribution Envelope (simple rules for now)
  if (!(itkMessage instanceof ITKSimpleMessageResponse)) {
    // Get the ITKService from the DirectoryOfService
    String serviceId = itkMessage.getMessageProperties().getServiceId()
    ITKService service = dos.getService(serviceId);
    if(service.isBase64()){
      String b64DocText = DatatypeConverter.printBase64Binary(...);
      itkMessage.setBusinessPayload(b64DocText);
    }
    return new DEWrappedMessage(service, itkMessage, true);      
  } 
}</pre></div>
                 <p class="caption"><b>Listing 4a</b> adding Distribution Envelope</p>
                 <br />
                 <div class="source"><pre class="prettyprint linenums">ITKMessage response = new WSSOAPMessageImpl(unwrappedResponseMsg, WSSOAPMessageImpl.SYNCRESP);</pre></div>
                 <p class="caption"><b>Listing 4b</b> adding SOAP wrappers</p>
             </div>
         </div>
    </div>
   

                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
              <div class="row span12">All content is available under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/" title="Open Government Licence">Open Government Licence</a>, except where otherwise stated<br/>
                                  All example source code is available under <a href="http://www.apache.org/licenses/LICENSE-2.0.html" title="Apache 2.0 License">Apache 2.0</a>, except where otherwise stated      
                    
                  <li id="publishDate" class="pull-right">Last Published: 2013-03-06</li> 
              <li id="projectVersion" class="pull-right">Version: 0.1-SNAPSHOT</li>
            </div>

        
                <p id="poweredBy" class="pull-right">
                                                                                                                      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop" title="ITK" class="builtBy">
        <img class="builtBy"  alt="ITK" src="images/itk-logo-2.png"    />
      </a>
                  </p>
        
                </div>
    </footer>
  </body>
</html>
